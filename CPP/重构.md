> ä»£ç ä¼šéšæ—¶é—´æµé€è€Œçƒ‚æ‰ã€‚å†™å¾—å†å¥½çš„ç¨‹åºä»£ç ï¼Œè‹¥æ˜¯å‘å¸ƒäº†å°±ä¸€ç›´ä¿æŒåŸæ ·ï¼Œç…§æ ·ä¼šé£åŒ–ã€ç ´ç¢ä¹ƒè‡³åˆ†å´©ç¦»æã€‚è½¯ä»¶ä¸æ­»ï¼Œé‡æ„ä¸æ­‡ã€‚

# æœ¬ä¹¦æœ‰ä»€ä¹ˆ

æœ¬ä¹¦çš„ç›®çš„æ˜¯å‘Šè¯‰è¯»è€…å¦‚ä½•ä»¥ä¸€ç§å¯æ§ä¸”é«˜æ•ˆçš„æ–¹å¼è¿›è¡Œé‡æ„ã€‚æˆ‘ä»¬å°†å­¦ä¼šå¦‚ä½•**æœ‰æ¡ä¸ç´Š**åœ°æ”¹è¿›ç¨‹åºç»“æ„ï¼Œå¹¶ä¸”**ä¸ä¼šå¼•å…¥é”™è¯¯**ã€‚ğŸ˜

# è¯»ä¹¦æŒ‡å—

- **å¦‚æœæƒ³çŸ¥é“é‡æ„æ˜¯ä»€ä¹ˆ**ï¼Œè¯·é˜…è¯»ç¬¬ä¸€ç« ã€‚

- **å¦‚æœæƒ³çŸ¥é“ä¸ºä»€ä¹ˆåº”è¯¥é‡æ„**ï¼Œé˜…è¯»å‰ä¸¤ç« ã€‚

- **å¦‚æœæƒ³çŸ¥é“æ”¹åœ¨ä»€ä¹ˆåœ°æ–¹é‡æ„**ï¼Œé˜…è¯»ç¬¬ä¸‰ç« ã€‚

- **å¦‚æœæƒ³ç€æ‰‹è¿›è¡Œé‡æ„**ï¼Œè¯·å®Œæ•´é˜…è¯»å‰å››ç« ã€‚

# ç¬¬ä¸€ç«  é‡æ„ï¼Œç¬¬ä¸€ä¸ªç¤ºä¾‹

> è®²å†å²ã€ä¸»è¦åŸç†ä¼šè¯±å‘æˆ‘çš„çŒç¡è™«ï¼Œé‚£ä¹ˆä»ç¤ºä¾‹å¼€å§‹å§

å‡è®¾æœ‰ä¸€ä¸ªç”µå­å•†åŠ¡å¹³å°ï¼Œç”¨æˆ·ç»å¸¸åœ¨å¹³å°ä¸Šè´­ä¹°å„ç§å•†å“ã€‚é€šå¸¸ç”¨æˆ·ä¼šè´­ä¹°å¤šä¸ªå•†å“ï¼Œè€Œå¹³å°åˆ™**æ ¹æ®å•†å“ç§ç±»å’Œæ•°é‡æ¥æ”¶è´¹**ã€‚å¹³å°ä¸Šç›®å‰æœ‰ä¸¤ç§å•†å“ï¼š**ç”µå­äº§å“å’Œæœè£…**ã€‚å½“ç”¨æˆ·ç»“ç®—è´¦å•æ—¶ï¼Œä¼šæ ¹æ®ä¸åŒç±»å‹çš„äº§å“ç®—è¿è´¹ï¼Œæ­¤å¤–å¹³å°è¿˜ä¼šæ ¹æ®è´­ä¹°å•†å“çš„æ•°é‡**ç»™å‡ºâ€œè´­ç‰©ç§¯åˆ†â€ä¼˜æƒ **ï¼Œä¸‹æ¬¡ç”¨æˆ·å†è´­ç‰©æ—¶å¯ä»¥**ä½¿ç”¨ç§¯åˆ†è·å¾—æŠ˜æ‰£**ï¼Œè¿™å¯ä»¥æå‡ç”¨æˆ·çš„å¿ è¯šåº¦ã€‚

**å•†å“ products.json**

```python
products = {
    "æ‰‹é“¾": {
        "name": "æ‰‹é“¾",
        "category": "é¥°å“"
    },
    "Tæ¤": {
        "name": "Tæ¤",
        "category": "è¡£æœ"
    },
    "é’¥åŒ™æ‰£": {
        "name": "é’¥åŒ™æ‰£",
        "category": "é¥°å“"
    }
}
```

**è´¦å• invoices.json**

```json
invoice = {
    "customer": "å¼ ä¸‰",
    "purchases": [
        {
            "productID": "æ‰‹é“¾",
            "quantity": 10
        },
        {
            "productID": "Tæ¤",
            "quantity": 20
        },
        {
            "productID": "é’¥åŒ™æ‰£",
            "quantity": 30
        }
    ]
}
```

**æ‰“å°è´¦å•è¯¦æƒ…**

```python
# recode.py
def statement(invoice, products):
    totalAmount = 0
    volumeCredits = 0
    result = f"Statement for {invoice['customer']}:\n"
    format = lambda x: f"${x:.2f}"

    for purchase in invoice['purchases']:
        product = products[purchase['productID']]
        thisAmount = 0

        if product['category'] == "é¥°å“":
            # é¥°å“åŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡2ä»¶æ¯ä»¶5å—ï¼›å°é¥°å“ç»Ÿç»Ÿ5å—
            thisAmount = 10
            if purchase['quantity'] > 2:
                thisAmount += 5 * (purchase['quantity'] - 2)
            thisAmount += 5 * purchase['quantity']
        elif product['category'] == "è¡£æœ":
            # è¡£æœåŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡3ä»¶æ¯ä»¶5å—ï¼Œå¹¶åŠ 3å—é’±åŒ…è£…è´¹ï¼›è¡£æœé€šé€š50ä¸€ä»¶
            thisAmount = 10
            if purchase['quantity'] > 3:
                thisAmount += 3 + 5 * (purchase['quantity'] - 3)
            thisAmount += 50 * purchase['quantity']
        else:
            raise ValueError(f"Unknown category: {product['category']}")

        # è¶…è¿‡3ä»¶æ‰ç§¯åˆ†
        volumeCredits += max(purchase['quantity'] - 3, 0)
        # è¡£æœç§¯åˆ†é¢å¤–åŠ 20%
        if product['category'] == "è¡£æœ":
            volumeCredits += purchase['quantity'] / 5

        result += f"{product['name']}: {format(thisAmount)} ({purchase['quantity']} units)\n"
        totalAmount += thisAmount

    result += f"Amount owed is {format(totalAmount)}\n"
    result += f"You earned {volumeCredits} credits\n"

    return result

print(statement(invoice, products))
# Statement for å¼ ä¸‰:
# æ‰‹é“¾: $100.00 (10 units)
# Tæ¤: $1098.00 (20 units)
# é’¥åŒ™æ‰£: $300.00 (30 units)
# Amount owed is $1498.00
# You earned 55.0 credits
```

ä»£ç â€œä¸ç”šæ¸…æ™°â€ï¼Œä½†è€ƒè™‘ä»¥ä¸‹å˜åŒ–ï¼š

1. å¸Œæœ›ä»¥HTMLè¾“å‡ºè¯¦å•
   
   è¿™ä¼šå¸¦æ¥ä»€ä¹ˆå˜åŒ–ï¼Ÿå¯¹äºæ¯æ¬¡è¿½åŠ å­—ç¬¦ä¸²åˆ°resultå˜é‡éƒ½å¾—æ·»åŠ åˆ†æ”¯é€»è¾‘ï¼Œå¦ä¸€ç§æ–¹æ³•å°±æ˜¯**ç›´æ¥å¤åˆ¶æ•´ä¸ªå‡½æ•°**ï¼Œåœ¨æ–°çš„å‡½æ•°é‡Œé¢å…¶ä¸­ä¿®æ”¹è¾“å‡ºhtmlçš„é€»è¾‘ã€‚

2. å•†å“ç§ç±»è¶Šæ¥è¶Šå¤šï¼Œè®¡ç®—è¿è´¹å’Œè®¡ç®—ç§¯åˆ†çš„æ–¹å¼éƒ½ä¼šæœ‰æ”¹å˜
   
   å¦‚æœä¸Šé¢å¤åˆ¶äº†å‡½æ•°ï¼Œé‚£ä¹ˆ**å¿…é¡»ç¡®ä¿å°†æ¥çš„ä»»ä½•ä¿®æ”¹åœ¨è¿™ä¸¤ä¸ªåœ°æ–¹ä¿æŒä¸€è‡´**ï¼Œé‚£ä¹ˆé€‚å½“çš„ä¿®æ”¹ç‚¹å°†è¶Šæ¥è¶Šéš¾æ‰¾ï¼Œ**ä¸çŠ¯é”™çš„æœºä¼šä¹Ÿä¼šè¶Šæ¥è¶Šå°‘**ğŸ˜”ã€‚

> å¦‚æœä½ æƒ³è¦ç»™ç¨‹åºæ·»åŠ ä¸€ä¸ªç‰¹æ€§ï¼Œä½†å‘ç°ä»£ç å› ç¼ºä¹è‰¯å¥½çš„ç»“æ„è€Œä¸æ˜“äºè¿›è¡Œæ›´æ”¹ï¼Œé‚£å°±é‡æ„é‚£ä¸ªç¨‹åºï¼Œä½¿å…¶æ¯”è¾ƒå®¹æ˜“æ·»åŠ è¯¥ç‰¹æ€§ï¼Œç„¶åå†å»æ·»åŠ 

## é‡æ„çš„ç¬¬ä¸€æ­¥

ç¬¬ä¸€æ­¥æ°¸è¿œç›¸åŒï¼š**ç¡®ä¿å³å°†ä¿®æ”¹çš„ä»£ç æ‹¥æœ‰ä¸€ç»„å¯é çš„æµ‹è¯•**

> åœ¨æ•°å­—æ—¶ä»£ï¼Œè½¯ä»¶çš„åå­—å°±æ˜¯è„†å¼±ğŸ˜

`statement`å‡½æ•°è¿”å›å€¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦åšçš„å°±æ˜¯åˆ›å»ºå‡ å¼ æ–°çš„è´¦å•ï¼Œå¹¶å°†è¾“å‡ºå’Œé¢„æœŸè¾“å‡ºè¿›è¡Œå¯¹æ¯”ã€‚

```python
# test_recode.py
import pytest
from recode import statement
from recode import products

def test_statement():
    # Test Case 1
    invoice1 = {
        "customer": "å¼ ä¸‰",
        "purchases": [
            {
                "productID": "æ‰‹é“¾",
                "quantity": 10
            },
            {
                "productID": "Tæ¤",
                "quantity": 20
            },
            {
                "productID": "é’¥åŒ™æ‰£",
                "quantity": 30
            }
        ]
    }
    expected_result1 = "Statement for å¼ ä¸‰:\næ‰‹é“¾: $100.00 (10 units)\nTæ¤: $1098.00 (20 units)\né’¥åŒ™æ‰£: $300.00 (30 units)\nAmount owed is $1498.00\nYou earned 55.0 credits\n"
    assert statement(invoice1, products) == expected_result1

    # Test Case 2
    invoice2 = {
        "customer": "æå››",
        "purchases": [
            {
                "productID": "Tæ¤",
                "quantity": 5
            }
        ]
    }
    expected_result2 = 'Statement for æå››:\nTæ¤: $273.00 (5 units)\nAmount owed is $273.00\nYou earned 3.0 credits\n'
    assert statement(invoice2, products) == expected_result2

    # Test Case 3
    invoice3 = {
        "customer": "ç‹äº”",
        "purchases": [
            {
                "productID": "æ‰‹é“¾",
                "quantity": 3
            },
            {
                "productID": "Tæ¤",
                "quantity": 4
            },
            {
                "productID": "é’¥åŒ™æ‰£",
                "quantity": 2
            }
        ]
    }
    expected_result3 = 'Statement for ç‹äº”:\næ‰‹é“¾: $30.00 (3 units)\nTæ¤: $218.00 (4 units)\né’¥åŒ™æ‰£: $20.00 (2 units)\nAmount owed is $268.00\nYou earned 1.8 credits\n'
    assert statement(invoice3, products) == expected_result3

    print("All test cases passed!")

if __name__ == "__main__":
    pytest.main(["-vv"])
```

# åˆ†è§£statementå‡½æ•°

ç¬¬ä¸€çœ¼è‚¯å®šæ³¨æ„åˆ°ä¸­é—´é‚£æ®µçš„ifè¯­å¥ï¼Œå¾—å…ˆå°†è¿™å—ä»£ç æŠ½å–æˆä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°ï¼ŒæŒ‰å®ƒæ‰€å¹²çš„äº‹å‘½åï¼Œæ¯”å¦‚å«`amountFor`ï¼Œè¿™æ ·ä¸‹æ¬¡çœ‹çš„æ—¶å€™ï¼Œç›´æ¥å°±çŸ¥é“ä»–åœ¨å¹²ä»€ä¹ˆå•¦ã€‚

### æç‚¼å‡½æ•°(106)

1. æ£€æŸ¥ä¸‹ï¼Œå¦‚æœæç‚¼åˆ°ä¸€ä¸ªå‡½æ•°é‡Œï¼Œå“ªäº›å˜é‡ä¼šç¦»å¼€åŸæœ¬çš„ä½œç”¨åŸŸã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ˜¯`purchaseã€productã€thisAmount`è¿™ä¸‰ä¸ªå˜é‡ï¼Œå‰ä¸¤è€…ä¸ä¼šè¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆå¯ä»¥å°†å®ƒä»¬ä»¥å‚æ•°çš„æ–¹å¼ä¼ è¿›æ¥ã€‚`thisAmount`è¦ä¿®æ”¹ï¼Œä¸”åªæœ‰å”¯ä¸€ä¸€ä¸ªï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å‡½æ•°ç›´æ¥è¿”å›ã€‚

```python
def amountFor(purchase, product):
    if product['category'] == "é¥°å“":
        # é¥°å“åŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡2ä»¶æ¯ä»¶5å—ï¼›å°é¥°å“ç»Ÿç»Ÿ5å—
        thisAmount = 10
        if purchase['quantity'] > 2:
            thisAmount += 5 * (purchase['quantity'] - 2)
        thisAmount += 5 * purchase['quantity']
    elif product['category'] == "è¡£æœ":
        # è¡£æœåŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡3ä»¶æ¯ä»¶5å—ï¼Œå¹¶åŠ 3å—é’±åŒ…è£…è´¹ï¼›è¡£æœé€šé€š50ä¸€ä»¶
        thisAmount = 10
        if purchase['quantity'] > 3:
            thisAmount += 3 + 5 * (purchase['quantity'] - 3)
        thisAmount += 50 * purchase['quantity']
    else:
        raise ValueError(f"Unknown category: {product['category']}")
    return thisAmount

def statement(invoice, products):
    totalAmount = 0
    volumeCredits = 0
    result = f"Statement for {invoice['customer']}:\n"
    format = lambda x: f"${x:.2f}"

    for purchase in invoice['purchases']:
        product = products[purchase['productID']]
        thisAmount = 0

        thisAmount = amountFor(purchase, product)

        # è¶…è¿‡3ä»¶æ‰ç§¯åˆ†
        # ......
```

**æç‚¼å‡½æ•°**æ˜¯ä¸€ç§å¸¸è§çš„å¯è‡ªåŠ¨å®Œæˆçš„é‡æ„ï¼Œä¸€èˆ¬`ide`éƒ½æœ‰è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ç”¨çš„`vscode`ç›´æ¥å³é”®é€‰æ‹©`refactor`ï¼Œideç›´æ¥å¸®ä½ ç”Ÿæˆå¥½å‡½æ•°ã€‚
2. æç‚¼å®Œæˆåï¼Œçœ‹çœ‹èƒ½å¦è¿›ä¸€æ­¥æå‡å…¶è¡¨è¾¾èƒ½åŠ›ã€‚ä¸€èˆ¬åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å˜é‡æ”¹åï¼Œä½¿ä»–ä»¬æ›´ç®€æ´.å½“ä½¿ç”¨åŠ¨æ€å˜é‡ç±»å‹æ—¶ï¼Œè·Ÿè¸ªå˜é‡çš„ç±»å‹å¾ˆæœ‰å¿…è¦ï¼Œç»™å…³é”®ä¿¡æ¯é‡å‘½åï¼Œä¾‹å¦‚`product`æ”¹æˆ`singleItem`ï¼Œå¹¶ç»™å‡ºç±»å‹

```python
"""
    æ ¹æ®å•†å“ç›®å½•å’Œè´­ç‰©å•è®¡ç®—èŠ±è´¹
    singleItem: è´­ç‰©é‡Œçš„å•ä»¶å•†å“
    product: è´­ç‰©å•
    return: èŠ±è´¹é‡‘é¢
"""
def amountFor(singleItem:dict, product:dict) -> float:
    if product['category'] == "é¥°å“":
        # é¥°å“åŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡2ä»¶æ¯ä»¶5å—ï¼›å°é¥°å“ç»Ÿç»Ÿ5å—
        result = 10
        if singleItem['quantity'] > 2:
            result += 5 * (singleItem['quantity'] - 2)
        result += 5 * singleItem['quantity']
    elif product['category'] == "è¡£æœ":
        # è¡£æœåŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡3ä»¶æ¯ä»¶5å—ï¼Œå¹¶åŠ 3å—é’±åŒ…è£…è´¹ï¼›è¡£æœé€šé€š50ä¸€ä»¶
        result = 10
        if singleItem['quantity'] > 3:
            result += 3 + 5 * (singleItem['quantity'] - 3)
        result += 50 * singleItem['quantity']
    else:
        raise ValueError(f"Unknown category: {Product['category']}")
    return result
```

3. ç§»é™¤productå˜é‡ï¼Œå®ƒæ˜¯æ ¹æ®singleItemå˜é‡ç®—å‡ºæ¥çš„ï¼Œå› æ­¤æ²¡å¿…è¦ä½œä¸ºå‚æ•°ã€‚è¿™é‡Œç”¨çš„æ‰‹æ³•æ˜¯**ä»¥æŸ¥è¯¢å–ä»£ä¸´æ—¶å˜é‡ï¼ˆ178ï¼‰**

```python
def productFor(singleItem):
    return products[purchase['productID']]
...
def statement(shoppingCart, products):
    ...
    for singleItem in shoppingCart['shoppingCart']:
        product = productFor(singleItem)
        thisAmount = amountFor(singleItem, product)

        # è¶…è¿‡3ä»¶æ‰ç§¯åˆ†

        volumeCredits += max(singleItem['quantity'] - 3, 0)
```

ç¼–è¯‘ã€æµ‹è¯•ã€æäº¤ç„¶åå†ä½¿ç”¨ **å†…è”å˜é‡ï¼ˆ123ï¼‰** æ‰‹æ³•å†…è”å˜é‡`aProduct`

```python
Â Â Â Â Â Â Â Â # aProduct = productFor(singleItem)
Â Â Â Â Â Â Â Â thisAmount = amountFor(singleItem, productFor(singleItem))
        # è¶…è¿‡3ä»¶æ‰ç§¯åˆ†
        volumeCredits += max(singleItem['quantity'] - 3, 0)

        # è¡£æœç§¯åˆ†é¢å¤–åŠ 20%
        if productFor(singleItem)['category'] == "è¡£æœ":
            volumeCredits += singleItem['quantity'] / 5
        result += f"{productFor(singleItem)['name']}: {format(thisAmount)} ({singleItem['quantity']} units)\n"
        totalAmount += thisAmount

    result += f"Amount owed is {format(totalAmount)}\n"
    result += f"You earned {volumeCredits} credits\n"
    return result
```

ç¼–è¯‘ã€æµ‹è¯•ã€æäº¤ã€‚ä¸‹é¢å¼€å§‹ç§»é™¤`amountFor`çš„`product`**åº”ç”¨å‡½æ•°å£°æ˜ï¼ˆ124ï¼‰**ï¼Œé¦–å…ˆå‡½æ•°å†…éƒ¨ä½¿ç”¨æ–°æç‚¼çš„å‡½æ•°ã€‚

```python
def amountFor(singleItem:dict, productFor(singleItem):dict) -> float:
    if productFor(singleItem)['category'] == "é¥°å“":
        # é¥°å“åŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡2ä»¶æ¯ä»¶5å—ï¼›å°é¥°å“ç»Ÿç»Ÿ5å—
        result = 10
        if singleItem['quantity'] > 2:
            result += 5 * (singleItem['quantity'] - 2)
        result += 5 * singleItem['quantity']
    elif productFor(singleItem)['category'] == "è¡£æœ":
        # è¡£æœåŸºç¡€è¿è´¹10å—ï¼Œè¶…è¿‡3ä»¶æ¯ä»¶5å—ï¼Œå¹¶åŠ 3å—é’±åŒ…è£…è´¹ï¼›è¡£æœé€šé€š50ä¸€ä»¶
        result = 10
        if singleItem['quantity'] > 3:
            result += 3 + 5 * (singleItem['quantity'] - 3)
        result += 50 * singleItem['quantity']
    else:
        raise ValueError(f"Unknown category: {productFor(singleItem)['category']}")
    return result
```

ç¼–è¯‘ã€æµ‹è¯•ã€æäº¤ã€‚ç„¶åå»æ‰å‡½æ•°å£°æ˜ã€è°ƒç”¨

```python
def amountFor(singleItem:dict) -> float:
...
def statement(shoppingCart, products):
    ...
    thisAmount = amountFor(singleItem)
    ...
```

ç„¶åå†ä¸€æ¬¡ç¼–è¯‘ã€æµ‹è¯•ã€æäº¤ã€‚åšä»»ä½•æç‚¼å‰ï¼Œä¸€èˆ¬å…ˆç§»é™¤å±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬çœ‹`thisAmount`å˜é‡ï¼Œèµ‹å€¼ç»™ä¸€ä¸ªå˜é‡åå°±ä¸å†è¢«ä¿®æ”¹ã€‚å› æ­¤åˆé‡‡ç”¨ **å†…æ•›å˜é‡ï¼ˆ123ï¼‰** æ‰‹æ³•å†…è”å®ƒ

```python
result += f"{productFor(singleItem)['name']}: {format(amountFor(singleItem))} ({singleItem['quantity']} units)\n"
totalAmount += amountFor(singleItem)
```

4. æç‚¼è®¡ç®—ç§¯åˆ†çš„é€»è¾‘
